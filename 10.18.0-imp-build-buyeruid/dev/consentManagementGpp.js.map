{"version":3,"file":"consentManagementGpp.js","mappings":"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","sources":["webpack:///../../modules/consentManagementGpp.ts"],"sourcesContent":["/**\n * This module adds GPP consentManagement support to prebid.js.  It interacts with\n * supported CMPs (Consent Management Platforms) to grab the user's consent information\n * and make it available for any GPP supported adapters to read/pass this information to\n * their system and for various other features/modules in Prebid.js.\n */\nimport {deepSetValue, isEmpty, isPlainObject, isStr, logInfo, logWarn} from '../src/utils.js';\nimport {config} from '../src/config.js';\nimport {gppDataHandler} from '../src/adapterManager.js';\nimport {enrichFPD} from '../src/fpd/enrichment.js';\nimport {cmpClient, MODE_CALLBACK} from '../libraries/cmp/cmpClient.js';\nimport {PbPromise, defer} from '../src/utils/promise.js';\nimport {type CMConfig, configParser} from '../libraries/consentManagement/cmUtils.js';\nimport {createCmpEventManager, type CmpEventManager} from '../libraries/cmp/cmpEventUtils.js';\nimport {CONSENT_GPP} from \"../src/consentHandler.ts\";\n\nexport let consentConfig = {} as any;\n\n// CMP event manager instance for GPP\nlet gppCmpEventManager: CmpEventManager | null = null;\n\ntype RelevantCMPData = {\n  applicableSections: number[]\n  gppString: string;\n  parsedSections: Record<string, unknown>\n}\n\ntype CMPData = RelevantCMPData & { [key: string]: unknown };\n\nexport type GPPConsentData = RelevantCMPData & {\n  gppData: CMPData;\n}\n\n// eslint-disable-next-line @typescript-eslint/no-empty-object-type\nexport interface GPPConfig {\n  // this is here to be extended by the control modules\n}\n\nexport type GPPCMConfig = GPPConfig & CMConfig<RelevantCMPData>;\n\ndeclare module '../src/consentHandler' {\n  interface ConsentData {\n    [CONSENT_GPP]: GPPConsentData;\n  }\n  interface ConsentManagementConfig {\n    [CONSENT_GPP]?: GPPCMConfig;\n  }\n}\n\nclass GPPError {\n  message;\n  args;\n  constructor(message, arg?) {\n    this.message = message;\n    this.args = arg == null ? [] : [arg];\n  }\n}\n\nexport class GPPClient {\n  apiVersion = '1.1';\n  cmp;\n  static INST;\n\n  static get(mkCmp = cmpClient) {\n    if (this.INST == null) {\n      const cmp = mkCmp({\n        apiName: '__gpp',\n        apiArgs: ['command', 'callback', 'parameter'], // do not pass version - not clear what it's for (or what we should use),\n        mode: MODE_CALLBACK\n      });\n      if (cmp == null) {\n        throw new GPPError('GPP CMP not found');\n      }\n      this.INST = new this(cmp);\n    }\n    return this.INST;\n  }\n\n  #resolve;\n  #reject;\n  #pending = [];\n\n  initialized = false;\n\n  constructor(cmp) {\n    this.cmp = cmp;\n    [this.#resolve, this.#reject] = ['resolve', 'reject'].map(slot => (result) => {\n      while (this.#pending.length) {\n        this.#pending.pop()[slot](result);\n      }\n    });\n  }\n\n  /**\n   * initialize this client - update consent data if already available,\n   * and set up event listeners to also update on CMP changes\n   *\n   * @param pingData\n   * @returns {Promise<{}>} a promise to GPP consent data\n   */\n  init(pingData) {\n    const ready = this.updateWhenReady(pingData);\n    if (!this.initialized) {\n      if (pingData.gppVersion !== this.apiVersion) {\n        logWarn(`Unrecognized GPP CMP version: ${pingData.apiVersion}. Continuing using GPP API version ${this.apiVersion}...`);\n      }\n      this.initialized = true;\n\n      // Initialize CMP event manager and set CMP API\n      if (!gppCmpEventManager) {\n        gppCmpEventManager = createCmpEventManager('gpp');\n      }\n      gppCmpEventManager.setCmpApi(this.cmp);\n\n      this.cmp({\n        command: 'addEventListener',\n        callback: (event, success) => {\n          if (success != null && !success) {\n            this.#reject(new GPPError('Received error response from CMP', event));\n          } else if (event?.pingData?.cmpStatus === 'error') {\n            this.#reject(new GPPError('CMP status is \"error\"; please check CMP setup', event));\n          } else if (this.isCMPReady(event?.pingData || {}) && ['sectionChange', 'signalStatus'].includes(event?.eventName)) {\n            this.#resolve(this.updateConsent(event.pingData));\n          }\n          // NOTE: according to https://github.com/InteractiveAdvertisingBureau/Global-Privacy-Platform/blob/main/Core/CMP%20API%20Specification.md,\n          // > [signalStatus] Event is called whenever the display status of the CMP changes (e.g. the CMP shows the consent layer).\n          //\n          // however, from real world testing, at least some CMPs only trigger 'cmpDisplayStatus'\n          // other CMPs may do something else yet; here we just look for 'signalStatus: not ready' on any event\n          // to decide if consent data is likely to change\n          if (gppDataHandler.getConsentData() != null && event?.pingData != null && !this.isCMPReady(event.pingData)) {\n            gppDataHandler.setConsentData(null);\n          }\n\n          if (event?.listenerId !== null && event?.listenerId !== undefined) {\n            gppCmpEventManager?.setCmpListenerId(event?.listenerId);\n          }\n        }\n      });\n    }\n    return ready;\n  }\n\n  refresh() {\n    return this.cmp({command: 'ping'}).then(this.init.bind(this));\n  }\n\n  /**\n   * Retrieve and store GPP consent data.\n   *\n   * @param pingData\n   * @returns {Promise<{}>} a promise to GPP consent data\n   */\n  updateConsent(pingData) {\n    return new PbPromise(resolve => {\n      if (pingData == null || isEmpty(pingData)) {\n        throw new GPPError('Received empty response from CMP', pingData);\n      }\n      const consentData = parseConsentData(pingData);\n      logInfo('Retrieved GPP consent from CMP:', consentData);\n      gppDataHandler.setConsentData(consentData);\n      resolve(consentData);\n    });\n  }\n\n  /**\n   * Return a promise to GPP consent data, to be retrieved the next time the CMP signals it's ready.\n   *\n   * @returns {Promise<{}>}\n   */\n  nextUpdate() {\n    const def = defer();\n    this.#pending.push(def);\n    return def.promise;\n  }\n\n  /**\n   * Return a promise to GPP consent data, to be retrieved immediately if the CMP is ready according to `pingData`,\n   * or as soon as it signals that it's ready otherwise.\n   *\n   * @param pingData\n   * @returns {Promise<{}>}\n   */\n  updateWhenReady(pingData) {\n    return this.isCMPReady(pingData) ? this.updateConsent(pingData) : this.nextUpdate();\n  }\n\n  isCMPReady(pingData) {\n    return pingData.signalStatus === 'ready';\n  }\n}\n\nfunction lookupIabConsent() {\n  return new PbPromise((resolve) => resolve(GPPClient.get().refresh()))\n}\n\n// add new CMPs here, with their dedicated lookup function\nconst cmpCallMap = {\n  'iab': lookupIabConsent,\n};\n\nfunction parseConsentData(cmpData) {\n  if (\n    (cmpData?.applicableSections != null && !Array.isArray(cmpData.applicableSections)) ||\n    (cmpData?.gppString != null && !isStr(cmpData.gppString)) ||\n    (cmpData?.parsedSections != null && !isPlainObject(cmpData.parsedSections))\n  ) {\n    throw new GPPError('CMP returned unexpected value during lookup process.', cmpData);\n  }\n  ['usnatv1', 'uscav1'].forEach(section => {\n    if (cmpData?.parsedSections?.[section]) {\n      logWarn(`Received invalid section from cmp: '${section}'. Some functionality may not work as expected`, cmpData);\n    }\n  });\n  return toConsentData(cmpData);\n}\n\nexport function toConsentData(gppData = {} as any): GPPConsentData {\n  return {\n    gppString: gppData?.gppString,\n    applicableSections: gppData?.applicableSections || [],\n    parsedSections: gppData?.parsedSections || {},\n    gppData: gppData\n  };\n}\n\n/**\n * Simply resets the module's consentData variable back to undefined, mainly for testing purposes\n */\nexport function resetConsentData() {\n  consentConfig = {};\n  gppDataHandler.reset();\n  GPPClient.INST = null;\n}\n\nexport function removeCmpListener() {\n  // Clean up CMP event listeners before resetting\n  if (gppCmpEventManager) {\n    gppCmpEventManager.removeCmpEventListener();\n    gppCmpEventManager = null;\n  }\n  resetConsentData();\n}\n\nconst parseConfig = configParser({\n  namespace: 'gpp',\n  displayName: 'GPP',\n  consentDataHandler: gppDataHandler,\n  parseConsentData,\n  getNullConsent: () => toConsentData(null),\n  cmpHandlers: cmpCallMap,\n  cmpEventCleanup: removeCmpListener\n});\n\nexport function setConsentConfig(config) {\n  consentConfig = parseConfig(config);\n  return consentConfig.loadConsentData?.()?.catch?.(() => null);\n}\nconfig.getConfig('consentManagement', config => setConsentConfig(config.consentManagement));\n\nexport function enrichFPDHook(next, fpd) {\n  return next(fpd.then(ortb2 => {\n    const consent = gppDataHandler.getConsentData();\n    if (consent) {\n      if (Array.isArray(consent.applicableSections)) {\n        deepSetValue(ortb2, 'regs.gpp_sid', consent.applicableSections);\n      }\n      deepSetValue(ortb2, 'regs.gpp', consent.gppString);\n    }\n    return ortb2;\n  }));\n}\n\nenrichFPD.before(enrichFPDHook);\n"],"names":["registerModule","__r0","deepSetValue","isEmpty","isPlainObject","isStr","logInfo","logWarn","config","gppDataHandler","enrichFPD","cmpClient","MODE_CALLBACK","PbPromise","defer","configParser","createCmpEventManager","CONSENT_GPP","consentConfig","gppCmpEventManager","GPPError","constructor","message","arg","_defineProperty","args","_resolve","WeakMap","_reject","_pending","GPPClient","get","mkCmp","arguments","length","undefined","INST","cmp","apiName","apiArgs","mode","_classPrivateFieldInitSpec","_toSetter","_classPrivateFieldSet","_","map","slot","result","_classPrivateFieldGet","pop","init","pingData","ready","updateWhenReady","initialized","gppVersion","apiVersion","concat","setCmpApi","command","callback","event","success","_event$pingData","call","cmpStatus","isCMPReady","includes","eventName","updateConsent","getConsentData","setConsentData","listenerId","_gppCmpEventManager","setCmpListenerId","refresh","then","bind","resolve","consentData","parseConsentData","nextUpdate","def","push","promise","signalStatus","lookupIabConsent","cmpCallMap","cmpData","applicableSections","Array","isArray","gppString","parsedSections","forEach","section","_cmpData$parsedSectio","toConsentData","gppData","resetConsentData","reset","removeCmpListener","removeCmpEventListener","parseConfig","namespace","displayName","consentDataHandler","getNullConsent","cmpHandlers","cmpEventCleanup","setConsentConfig","_consentConfig$loadCo","_consentConfig","_consentConfig$loadCo2","loadConsentData","catch","getConfig","consentManagement","enrichFPDHook","next","fpd","ortb2","consent","before"],"sourceRoot":""}