{"version":3,"file":"consentManagementTcf.js","mappings":"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","sources":["webpack:///../../modules/consentManagementTcf.ts"],"sourcesContent":["/**\n * This module adds GDPR consentManagement support to prebid.js.  It interacts with\n * supported CMPs (Consent Management Platforms) to grab the user's consent information\n * and make it available for any GDPR supported adapters to read/pass this information to\n * their system.\n */\nimport {deepSetValue, isStr, logInfo} from '../src/utils.js';\nimport {config} from '../src/config.js';\nimport {gdprDataHandler} from '../src/adapterManager.js';\nimport {registerOrtbProcessor, REQUEST} from '../src/pbjsORTB.js';\nimport {enrichFPD} from '../src/fpd/enrichment.js';\nimport {cmpClient} from '../libraries/cmp/cmpClient.js';\nimport {configParser} from '../libraries/consentManagement/cmUtils.js';\nimport {createCmpEventManager, type CmpEventManager} from '../libraries/cmp/cmpEventUtils.js';\nimport {CONSENT_GDPR} from \"../src/consentHandler.ts\";\nimport type {CMConfig} from \"../libraries/consentManagement/cmUtils.ts\";\n\nexport let consentConfig: any = {};\nexport let gdprScope;\nlet dsaPlatform;\nconst CMP_VERSION = 2;\n\n// add new CMPs here, with their dedicated lookup function\nconst cmpCallMap = {\n  'iab': lookupIabConsent,\n};\n\n// CMP event manager instance for TCF\nexport let tcfCmpEventManager: CmpEventManager | null = null;\n\n/**\n * @see https://github.com/InteractiveAdvertisingBureau/GDPR-Transparency-and-Consent-Framework\n * @see https://github.com/InteractiveAdvertisingBureau/iabtcf-es/tree/master/modules/core#iabtcfcore\n */\nexport type TCFConsentData = {\n  apiVersion: typeof CMP_VERSION;\n  /**\n   * The consent string.\n   */\n  consentString: string;\n  /**\n   * True if GDPR is in scope.\n   */\n  gdprApplies: boolean;\n  /**\n   * The response from the CMP.\n   */\n  vendorData: Record<string, unknown>;\n  /**\n   * Additional consent string, if provided by the CMP.\n   * @see https://support.google.com/admanager/answer/9681920?hl=en\n   */\n  addtlConsent?: `${number}~${string}~${string}`;\n}\n\nexport interface TCFConfig {\n  /**\n   *  Defines what the gdprApplies flag should be when the CMP doesn’t respond in time or the static data doesn’t supply.\n   *  Defaults to false.\n   */\n  defaultGdprScope?: boolean;\n  /**\n   * If true, indicates that the publisher is to be considered an “Online Platform” for the purposes of the Digital Services Act\n   */\n  dsaPlatform?: boolean;\n}\n\ntype TCFCMConfig = TCFConfig & CMConfig<TCFConsentData>;\n\ndeclare module '../src/consentHandler' {\n  interface ConsentData {\n    [CONSENT_GDPR]: TCFConsentData;\n  }\n  interface ConsentManagementConfig {\n    [CONSENT_GDPR]?: TCFCMConfig;\n  }\n}\n\n/**\n * This function handles interacting with an IAB compliant CMP to obtain the consent information of the user.\n */\nfunction lookupIabConsent(setProvisionalConsent) {\n  return new Promise<void>((resolve, reject) => {\n    function cmpResponseCallback(tcfData, success) {\n      logInfo('Received a response from CMP', tcfData);\n      if (success) {\n        try {\n          setProvisionalConsent(parseConsentData(tcfData));\n        } catch (e) {\n        }\n\n        if (tcfData.gdprApplies === false || tcfData.eventStatus === 'tcloaded' || tcfData.eventStatus === 'useractioncomplete') {\n          try {\n            if (tcfData.listenerId !== null && tcfData.listenerId !== undefined) {\n              tcfCmpEventManager?.setCmpListenerId(tcfData.listenerId);\n            }\n            gdprDataHandler.setConsentData(parseConsentData(tcfData));\n            resolve();\n          } catch (e) {\n            reject(e);\n          }\n        }\n      } else {\n        reject(Error('CMP unable to register callback function.  Please check CMP setup.'))\n      }\n    }\n\n    const cmp = cmpClient({\n      apiName: '__tcfapi',\n      apiVersion: CMP_VERSION,\n      apiArgs: ['command', 'version', 'callback', 'parameter'],\n    });\n\n    if (!cmp) {\n      reject(new Error('TCF2 CMP not found.'))\n    }\n    if ((cmp as any).isDirect) {\n      logInfo('Detected CMP API is directly accessible, calling it now...');\n    } else {\n      logInfo('Detected CMP is outside the current iframe where Prebid.js is located, calling it now...');\n    }\n\n    // Initialize CMP event manager and set CMP API\n    if (!tcfCmpEventManager) {\n      tcfCmpEventManager = createCmpEventManager('tcf', () => gdprDataHandler.getConsentData());\n    }\n    tcfCmpEventManager.setCmpApi(cmp);\n\n    cmp({\n      command: 'addEventListener',\n      callback: cmpResponseCallback\n    })\n  })\n}\n\nfunction parseConsentData(consentObject): TCFConsentData {\n  function checkData() {\n    // if CMP does not respond with a gdprApplies boolean, use defaultGdprScope (gdprScope)\n    const gdprApplies = consentObject && typeof consentObject.gdprApplies === 'boolean' ? consentObject.gdprApplies : gdprScope;\n    const tcString = consentObject && consentObject.tcString;\n    return !!(\n      (typeof gdprApplies !== 'boolean') ||\n      (gdprApplies === true && (!tcString || !isStr(tcString)))\n    );\n  }\n\n  if (checkData()) {\n    throw Object.assign(new Error(`CMP returned unexpected value during lookup process.`), {args: [consentObject]})\n  } else {\n    return toConsentData(consentObject);\n  }\n}\n\nfunction toConsentData(cmpConsentObject) {\n  const consentData: TCFConsentData = {\n    consentString: (cmpConsentObject) ? cmpConsentObject.tcString : undefined,\n    vendorData: (cmpConsentObject) || undefined,\n    gdprApplies: cmpConsentObject && typeof cmpConsentObject.gdprApplies === 'boolean' ? cmpConsentObject.gdprApplies : gdprScope,\n    apiVersion: CMP_VERSION\n  };\n  if (cmpConsentObject && cmpConsentObject.addtlConsent && isStr(cmpConsentObject.addtlConsent)) {\n    consentData.addtlConsent = cmpConsentObject.addtlConsent;\n  }\n  return consentData;\n}\n\n/**\n * Simply resets the module's consentData variable back to undefined, mainly for testing purposes\n */\nexport function resetConsentData() {\n  consentConfig = {};\n  gdprDataHandler.reset();\n}\n\nexport function removeCmpListener() {\n  // Clean up CMP event listeners before resetting\n  if (tcfCmpEventManager) {\n    tcfCmpEventManager.removeCmpEventListener();\n    tcfCmpEventManager = null;\n  }\n  resetConsentData();\n}\n\nconst parseConfig = configParser({\n  namespace: 'gdpr',\n  displayName: 'TCF',\n  consentDataHandler: gdprDataHandler,\n  cmpHandlers: cmpCallMap,\n  parseConsentData,\n  getNullConsent: () => toConsentData(null),\n  cmpEventCleanup: removeCmpListener\n} as any)\n\n/**\n * A configuration function that initializes some module variables, as well as add a hook into the requestBids function\n */\nexport function setConsentConfig(config) {\n  // if `config.gdpr`, `config.usp` or `config.gpp` exist, assume new config format.\n  // else for backward compatability, just use `config`\n  const tcfConfig: TCFCMConfig = config && (config.gdpr || config.usp || config.gpp ? config.gdpr : config);\n  if ((tcfConfig?.consentData as any)?.getTCData != null) {\n    tcfConfig.consentData = (tcfConfig.consentData as any).getTCData;\n  }\n  gdprScope = tcfConfig?.defaultGdprScope === true;\n  dsaPlatform = !!tcfConfig?.dsaPlatform;\n  consentConfig = parseConfig({gdpr: tcfConfig});\n  return consentConfig.loadConsentData?.()?.catch?.(() => null);\n}\nconfig.getConfig('consentManagement', config => setConsentConfig(config.consentManagement));\n\nexport function enrichFPDHook(next, fpd) {\n  return next(fpd.then(ortb2 => {\n    const consent = gdprDataHandler.getConsentData();\n    if (consent) {\n      if (typeof consent.gdprApplies === 'boolean') {\n        deepSetValue(ortb2, 'regs.ext.gdpr', consent.gdprApplies ? 1 : 0);\n      }\n      deepSetValue(ortb2, 'user.ext.consent', consent.consentString);\n    }\n    if (dsaPlatform) {\n      deepSetValue(ortb2, 'regs.ext.dsa.dsarequired', 3);\n    }\n    return ortb2;\n  }));\n}\n\nenrichFPD.before(enrichFPDHook);\n\nexport function setOrtbAdditionalConsent(ortbRequest, bidderRequest) {\n  // this is not a standardized name for addtlConsent, so keep this as an ORTB library processor rather than an FPD enrichment\n  const addtl = bidderRequest.gdprConsent?.addtlConsent;\n  if (addtl && typeof addtl === 'string') {\n    deepSetValue(ortbRequest, 'user.ext.ConsentedProvidersSettings.consented_providers', addtl);\n  }\n}\n\nregisterOrtbProcessor({type: REQUEST, name: 'gdprAddtlConsent', fn: setOrtbAdditionalConsent})\n"],"names":["registerModule","__r0","deepSetValue","isStr","logInfo","config","gdprDataHandler","registerOrtbProcessor","REQUEST","enrichFPD","cmpClient","configParser","createCmpEventManager","CONSENT_GDPR","consentConfig","gdprScope","dsaPlatform","CMP_VERSION","cmpCallMap","lookupIabConsent","tcfCmpEventManager","setProvisionalConsent","Promise","resolve","reject","cmpResponseCallback","tcfData","success","parseConsentData","e","gdprApplies","eventStatus","listenerId","undefined","_tcfCmpEventManager","setCmpListenerId","setConsentData","Error","cmp","apiName","apiVersion","apiArgs","isDirect","getConsentData","setCmpApi","command","callback","consentObject","checkData","tcString","Object","assign","args","toConsentData","cmpConsentObject","consentData","consentString","vendorData","addtlConsent","resetConsentData","reset","removeCmpListener","removeCmpEventListener","parseConfig","namespace","displayName","consentDataHandler","cmpHandlers","getNullConsent","cmpEventCleanup","setConsentConfig","_tcfConfig$consentDat","_consentConfig$loadCo","_consentConfig","_consentConfig$loadCo2","tcfConfig","gdpr","usp","gpp","getTCData","defaultGdprScope","loadConsentData","call","catch","getConfig","consentManagement","enrichFPDHook","next","fpd","then","ortb2","consent","before","setOrtbAdditionalConsent","ortbRequest","bidderRequest","_bidderRequest$gdprCo","addtl","gdprConsent","type","name","fn"],"sourceRoot":""}