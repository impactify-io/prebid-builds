{"version":3,"file":"criteoIdSystem.js","mappings":"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","sources":["webpack://prebid.js/../../modules/criteoIdSystem.js"],"sourcesContent":["/**\n * This module adds Criteo Real Time User Sync to the User ID module\n * The {@link module:modules/userId} module is required\n * @module modules/criteoIdSystem\n * @requires module:modules/userId\n */\n\nimport { timestamp, parseUrl, triggerPixel, logError } from '../src/utils.js';\nimport { ajax } from '../src/ajax.js';\nimport { getRefererInfo } from '../src/refererDetection.js';\nimport { submodule } from '../src/hook.js';\nimport { getStorageManager } from '../src/storageManager.js';\nimport { MODULE_TYPE_UID } from '../src/activities/modules.js';\nimport { gdprDataHandler, uspDataHandler, gppDataHandler } from '../src/adapterManager.js';\n\n/**\n * @typedef {import('../modules/userId/index.js').Submodule} Submodule\n * @typedef {import('../modules/userId/index.js').SubmoduleConfig} SubmoduleConfig\n * @typedef {import('../modules/userId/index.js').ConsentData} ConsentData\n */\n\nconst gvlid = 91;\nconst bidderCode = 'criteo';\nexport const storage = getStorageManager({ moduleType: MODULE_TYPE_UID, moduleName: bidderCode });\n\nconst bididStorageKey = 'cto_bidid';\nconst bundleStorageKey = 'cto_bundle';\nconst dnaBundleStorageKey = 'cto_dna_bundle';\nconst cookiesMaxAge = 13 * 30 * 24 * 60 * 60 * 1000;\n\nconst STORAGE_TYPE_LOCALSTORAGE = 'html5';\nconst STORAGE_TYPE_COOKIES = 'cookie';\n\nconst pastDateString = new Date(0).toString();\nconst expirationString = new Date(timestamp() + cookiesMaxAge).toString();\n\nfunction extractProtocolHost(url, returnOnlyHost = false) {\n  const parsedUrl = parseUrl(url, { noDecodeWholeURL: true })\n  return returnOnlyHost\n    ? `${parsedUrl.hostname}`\n    : `${parsedUrl.protocol}://${parsedUrl.hostname}${parsedUrl.port ? ':' + parsedUrl.port : ''}/`;\n}\n\nfunction getFromStorage(submoduleConfig, key) {\n  if (submoduleConfig?.storage?.type === STORAGE_TYPE_LOCALSTORAGE) {\n    return storage.getDataFromLocalStorage(key);\n  } else if (submoduleConfig?.storage?.type === STORAGE_TYPE_COOKIES) {\n    return storage.getCookie(key);\n  }\n\n  return storage.getCookie(key) || storage.getDataFromLocalStorage(key);\n}\n\nfunction saveOnStorage(submoduleConfig, key, value, hostname) {\n  if (key && value) {\n    if (submoduleConfig?.storage?.type === STORAGE_TYPE_LOCALSTORAGE) {\n      storage.setDataInLocalStorage(key, value);\n    } else if (submoduleConfig?.storage?.type === STORAGE_TYPE_COOKIES) {\n      setCookieOnAllDomains(key, value, expirationString, hostname, true);\n    } else {\n      storage.setDataInLocalStorage(key, value);\n      setCookieOnAllDomains(key, value, expirationString, hostname, true);\n    }\n  }\n}\n\nfunction setCookieOnAllDomains(key, value, expiration, hostname, stopOnSuccess) {\n  const subDomains = hostname.split('.');\n  for (let i = 0; i < subDomains.length; ++i) {\n    // Try to write the cookie on this subdomain (we want it to be stored only on the TLD+1)\n    const domain = subDomains.slice(subDomains.length - i - 1, subDomains.length).join('.');\n\n    try {\n      storage.setCookie(key, value, expiration, null, '.' + domain);\n\n      if (stopOnSuccess) {\n        // Try to read the cookie to check if we wrote it\n        const ck = storage.getCookie(key);\n        if (ck && ck === value) {\n          break;\n        }\n      }\n    } catch (error) {\n\n    }\n  }\n}\n\nfunction deleteFromAllStorages(key, hostname) {\n  setCookieOnAllDomains(key, '', pastDateString, hostname, true);\n  storage.removeDataFromLocalStorage(key);\n}\n\nfunction getCriteoDataFromStorage(submoduleConfig) {\n  return {\n    bundle: getFromStorage(submoduleConfig, bundleStorageKey),\n    dnaBundle: getFromStorage(submoduleConfig, dnaBundleStorageKey),\n    bidId: getFromStorage(submoduleConfig, bididStorageKey),\n  }\n}\n\nfunction buildCriteoUsersyncUrl(topUrl, domain, bundle, dnaBundle, areCookiesWriteable, isLocalStorageWritable, isPublishertagPresent) {\n  let url = 'https://gum.criteo.com/sid/json?origin=prebid' +\n    `${topUrl ? '&topUrl=' + encodeURIComponent(topUrl) : ''}` +\n    `${domain ? '&domain=' + encodeURIComponent(domain) : ''}` +\n    `${bundle ? '&bundle=' + encodeURIComponent(bundle) : ''}` +\n    `${dnaBundle ? '&info=' + encodeURIComponent(dnaBundle) : ''}` +\n    `${areCookiesWriteable ? '&cw=1' : ''}` +\n    `${isPublishertagPresent ? '&pbt=1' : ''}` +\n    `${isLocalStorageWritable ? '&lsw=1' : ''}`;\n\n  const usPrivacyString = uspDataHandler.getConsentData();\n  if (usPrivacyString) {\n    url = url + `&us_privacy=${encodeURIComponent(usPrivacyString)}`;\n  }\n\n  const gdprConsent = gdprDataHandler.getConsentData()\n  if (gdprConsent) {\n    url = url + `${gdprConsent.consentString ? '&gdprString=' + encodeURIComponent(gdprConsent.consentString) : ''}`;\n    url = url + `&gdpr=${gdprConsent.gdprApplies === true ? 1 : 0}`;\n  }\n\n  const gppConsent = gppDataHandler.getConsentData();\n  if (gppConsent) {\n    url = url + `${gppConsent.gppString ? '&gpp=' + encodeURIComponent(gppConsent.gppString) : ''}`;\n    url = url + `${gppConsent.applicableSections ? '&gpp_sid=' + encodeURIComponent(gppConsent.applicableSections) : ''}`;\n  }\n\n  return url;\n}\n\nfunction callSyncPixel(submoduleConfig, domain, pixel) {\n  if (pixel.writeBundleInStorage && pixel.bundlePropertyName && pixel.storageKeyName) {\n    ajax(\n      pixel.pixelUrl,\n      {\n        success: response => {\n          if (response) {\n            const jsonResponse = JSON.parse(response);\n            if (jsonResponse && jsonResponse[pixel.bundlePropertyName]) {\n              saveOnStorage(submoduleConfig, pixel.storageKeyName, jsonResponse[pixel.bundlePropertyName], domain);\n            }\n          }\n        },\n        error: error => {\n          logError(`criteoIdSystem: unable to sync user id`, error);\n        }\n      },\n      undefined,\n      { method: 'GET', withCredentials: true }\n    );\n  } else {\n    triggerPixel(pixel.pixelUrl);\n  }\n}\n\nfunction callCriteoUserSync(submoduleConfig, parsedCriteoData, callback) {\n  const cw = (submoduleConfig?.storage?.type === undefined || submoduleConfig?.storage?.type === STORAGE_TYPE_COOKIES) && storage.cookiesAreEnabled();\n  const lsw = (submoduleConfig?.storage?.type === undefined || submoduleConfig?.storage?.type === STORAGE_TYPE_LOCALSTORAGE) && storage.localStorageIsEnabled();\n  const topUrl = extractProtocolHost(getRefererInfo().page);\n  // TODO: should domain really be extracted from the current frame?\n  const domain = extractProtocolHost(document.location.href, true);\n  const isPublishertagPresent = typeof criteo_pubtag !== 'undefined'; // eslint-disable-line camelcase\n\n  const url = buildCriteoUsersyncUrl(\n    topUrl,\n    domain,\n    parsedCriteoData.bundle,\n    parsedCriteoData.dnaBundle,\n    cw,\n    lsw,\n    isPublishertagPresent\n  );\n\n  const callbacks = {\n    success: response => {\n      const jsonResponse = JSON.parse(response);\n\n      if (jsonResponse.pixels) {\n        jsonResponse.pixels.forEach(pixel => callSyncPixel(submoduleConfig, domain, pixel));\n      }\n\n      if (jsonResponse.acwsUrl) {\n        const urlsToCall = typeof jsonResponse.acwsUrl === 'string' ? [jsonResponse.acwsUrl] : jsonResponse.acwsUrl;\n        urlsToCall.forEach(url => triggerPixel(url));\n      } else if (jsonResponse.bundle) {\n        saveOnStorage(submoduleConfig, bundleStorageKey, jsonResponse.bundle, domain);\n      }\n\n      if (jsonResponse.bidId) {\n        saveOnStorage(submoduleConfig, bididStorageKey, jsonResponse.bidId, domain);\n        const criteoId = { criteoId: jsonResponse.bidId };\n        callback(criteoId);\n      } else {\n        deleteFromAllStorages(bididStorageKey, domain);\n        callback();\n      }\n    },\n    error: error => {\n      logError(`criteoIdSystem: unable to sync user id`, error);\n      callback();\n    }\n  };\n\n  ajax(url, callbacks, undefined, { method: 'GET', contentType: 'application/json', withCredentials: true });\n}\n\n/** @type {Submodule} */\nexport const criteoIdSubmodule = {\n  /**\n   * used to link submodule with config\n   * @type {string}\n   */\n  name: bidderCode,\n  gvlid: gvlid,\n  /**\n   * decode the stored id value for passing to bid requests\n   * @function\n   * @returns {{criteoId: string} | undefined}\n   */\n  decode(bidId) {\n    return bidId;\n  },\n  /**\n   * get the Criteo Id from local storages and initiate a new user sync\n   * @function\n   * @param {SubmoduleConfig} [submoduleConfig]\n   * @returns {{id: {criteoId: string} | undefined}}}\n   */\n  getId(submoduleConfig) {\n    const localData = getCriteoDataFromStorage(submoduleConfig);\n\n    const result = (callback) => callCriteoUserSync(submoduleConfig, localData, callback);\n\n    return {\n      id: localData.bidId ? { criteoId: localData.bidId } : undefined,\n      callback: result\n    }\n  },\n  eids: {\n    'criteoId': {\n      source: 'criteo.com',\n      atype: 1\n    },\n  }\n};\n\nsubmodule('userId', criteoIdSubmodule);\n"],"names":["registerModule","__r0","timestamp","parseUrl","triggerPixel","logError","ajax","getRefererInfo","submodule","getStorageManager","MODULE_TYPE_UID","gdprDataHandler","uspDataHandler","gppDataHandler","gvlid","bidderCode","storage","moduleType","moduleName","bididStorageKey","bundleStorageKey","dnaBundleStorageKey","cookiesMaxAge","STORAGE_TYPE_LOCALSTORAGE","STORAGE_TYPE_COOKIES","pastDateString","Date","toString","expirationString","extractProtocolHost","url","returnOnlyHost","arguments","length","undefined","parsedUrl","noDecodeWholeURL","hostname","protocol","port","getFromStorage","submoduleConfig","key","type","getDataFromLocalStorage","getCookie","saveOnStorage","value","setDataInLocalStorage","setCookieOnAllDomains","expiration","stopOnSuccess","subDomains","split","i","domain","slice","join","setCookie","ck","error","deleteFromAllStorages","removeDataFromLocalStorage","getCriteoDataFromStorage","bundle","dnaBundle","bidId","buildCriteoUsersyncUrl","topUrl","areCookiesWriteable","isLocalStorageWritable","isPublishertagPresent","encodeURIComponent","usPrivacyString","getConsentData","gdprConsent","consentString","gdprApplies","gppConsent","gppString","applicableSections","callSyncPixel","pixel","writeBundleInStorage","bundlePropertyName","storageKeyName","pixelUrl","success","response","jsonResponse","JSON","parse","method","withCredentials","callCriteoUserSync","parsedCriteoData","callback","cw","cookiesAreEnabled","lsw","localStorageIsEnabled","page","document","location","href","criteo_pubtag","callbacks","pixels","forEach","acwsUrl","urlsToCall","criteoId","contentType","criteoIdSubmodule","name","decode","getId","localData","result","id","eids","source","atype"],"sourceRoot":""}