{"version":3,"file":"bidResponseFilter.js","mappings":"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","sources":["webpack://prebid.js/./modules/bidResponseFilter/index.js"],"sourcesContent":["import { auctionManager } from '../../src/auctionManager.js';\nimport { config } from '../../src/config.js';\nimport { getHook } from '../../src/hook.js';\n\nexport const MODULE_NAME = 'bidResponseFilter';\nexport const BID_CATEGORY_REJECTION_REASON = 'Category is not allowed';\nexport const BID_ADV_DOMAINS_REJECTION_REASON = 'Adv domain is not allowed';\nexport const BID_ATTR_REJECTION_REASON = 'Attr is not allowed';\n\nlet moduleConfig;\nlet enabled = false;\n\nfunction init() {\n  config.getConfig(MODULE_NAME, (cfg) => {\n    moduleConfig = cfg[MODULE_NAME];\n    if (enabled && !moduleConfig) {\n      reset();\n    } else if (!enabled && moduleConfig) {\n      enabled = true;\n      getHook('addBidResponse').before(addBidResponseHook);\n    }\n  })\n}\n\nexport function reset() {\n  enabled = false;\n  getHook('addBidResponse').getHooks({hook: addBidResponseHook}).remove();\n}\n\nexport function addBidResponseHook(next, adUnitCode, bid, reject, index = auctionManager.index) {\n  const {bcat = [], badv = []} = index.getOrtb2(bid) || {};\n  const battr = index.getBidRequest(bid)?.ortb2Imp[bid.mediaType]?.battr || index.getAdUnit(bid)?.ortb2Imp[bid.mediaType]?.battr || [];\n\n  const catConfig = {enforce: true, blockUnknown: true, ...(moduleConfig?.cat || {})};\n  const advConfig = {enforce: true, blockUnknown: true, ...(moduleConfig?.adv || {})};\n  const attrConfig = {enforce: true, blockUnknown: true, ...(moduleConfig?.attr || {})};\n\n  const { primaryCatId, secondaryCatIds = [], advertiserDomains = [], attr: metaAttr } = bid.meta || {};\n\n  // checking if bid fulfills ortb2 fields rules\n  if ((catConfig.enforce && bcat.some(category => [primaryCatId, ...secondaryCatIds].includes(category))) ||\n    (catConfig.blockUnknown && !primaryCatId)) {\n    reject(BID_CATEGORY_REJECTION_REASON);\n  } else if ((advConfig.enforce && badv.some(domain => advertiserDomains.includes(domain))) ||\n    (advConfig.blockUnknown && !advertiserDomains.length)) {\n    reject(BID_ADV_DOMAINS_REJECTION_REASON);\n  } else if ((attrConfig.enforce && battr.includes(metaAttr)) ||\n    (attrConfig.blockUnknown && !metaAttr)) {\n    reject(BID_ATTR_REJECTION_REASON);\n  } else {\n    return next(adUnitCode, bid, reject);\n  }\n}\n\ninit();\n"],"names":["registerModule","__r0","auctionManager","config","getHook","MODULE_NAME","BID_CATEGORY_REJECTION_REASON","BID_ADV_DOMAINS_REJECTION_REASON","BID_ATTR_REJECTION_REASON","moduleConfig","enabled","init","getConfig","cfg","reset","before","addBidResponseHook","getHooks","hook","remove","next","adUnitCode","bid","reject","index","arguments","length","undefined","bcat","badv","getOrtb2","battr","getBidRequest","ortb2Imp","mediaType","getAdUnit","catConfig","enforce","blockUnknown","cat","advConfig","adv","attrConfig","attr","primaryCatId","secondaryCatIds","advertiserDomains","metaAttr","meta","some","category","includes","domain"],"sourceRoot":""}