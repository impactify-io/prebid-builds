{"version":3,"file":"consentManagementTcf.js","mappings":"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","sources":["webpack://prebid.js/./modules/consentManagementTcf.js"],"sourcesContent":["/**\n * This module adds GDPR consentManagement support to prebid.js.  It interacts with\n * supported CMPs (Consent Management Platforms) to grab the user's consent information\n * and make it available for any GDPR supported adapters to read/pass this information to\n * their system.\n */\nimport {deepSetValue, isStr, logInfo} from '../src/utils.js';\nimport {config} from '../src/config.js';\nimport {gdprDataHandler} from '../src/adapterManager.js';\nimport {registerOrtbProcessor, REQUEST} from '../src/pbjsORTB.js';\nimport {enrichFPD} from '../src/fpd/enrichment.js';\nimport {cmpClient} from '../libraries/cmp/cmpClient.js';\nimport {configParser} from '../libraries/consentManagement/cmUtils.js';\n\nexport let consentConfig = {};\nexport let gdprScope;\nlet dsaPlatform;\nconst CMP_VERSION = 2;\n\n// add new CMPs here, with their dedicated lookup function\nconst cmpCallMap = {\n  'iab': lookupIabConsent,\n};\n\n/**\n * This function handles interacting with an IAB compliant CMP to obtain the consent information of the user.\n */\nfunction lookupIabConsent(setProvisionalConsent) {\n  return new Promise((resolve, reject) => {\n    function cmpResponseCallback(tcfData, success) {\n      logInfo('Received a response from CMP', tcfData);\n      if (success) {\n        try {\n          setProvisionalConsent(parseConsentData(tcfData));\n        } catch (e) {\n        }\n\n        if (tcfData.gdprApplies === false || tcfData.eventStatus === 'tcloaded' || tcfData.eventStatus === 'useractioncomplete') {\n          try {\n            gdprDataHandler.setConsentData(parseConsentData(tcfData));\n            resolve();\n          } catch (e) {\n            reject(e);\n          }\n        }\n      } else {\n        reject(Error('CMP unable to register callback function.  Please check CMP setup.'))\n      }\n    }\n\n    const cmp = cmpClient({\n      apiName: '__tcfapi',\n      apiVersion: CMP_VERSION,\n      apiArgs: ['command', 'version', 'callback', 'parameter'],\n    });\n\n    if (!cmp) {\n      reject(new Error('TCF2 CMP not found.'))\n    }\n    if (cmp.isDirect) {\n      logInfo('Detected CMP API is directly accessible, calling it now...');\n    } else {\n      logInfo('Detected CMP is outside the current iframe where Prebid.js is located, calling it now...');\n    }\n\n    cmp({\n      command: 'addEventListener',\n      callback: cmpResponseCallback\n    })\n  })\n}\n\nfunction parseConsentData(consentObject) {\n  function checkData() {\n    // if CMP does not respond with a gdprApplies boolean, use defaultGdprScope (gdprScope)\n    const gdprApplies = consentObject && typeof consentObject.gdprApplies === 'boolean' ? consentObject.gdprApplies : gdprScope;\n    const tcString = consentObject && consentObject.tcString;\n    return !!(\n      (typeof gdprApplies !== 'boolean') ||\n      (gdprApplies === true && (!tcString || !isStr(tcString)))\n    );\n  }\n\n  if (checkData()) {\n    throw Object.assign(new Error(`CMP returned unexpected value during lookup process.`), {args: [consentObject]})\n  } else {\n    return toConsentData(consentObject);\n  }\n}\n\nfunction toConsentData(cmpConsentObject) {\n  const consentData = {\n    consentString: (cmpConsentObject) ? cmpConsentObject.tcString : undefined,\n    vendorData: (cmpConsentObject) || undefined,\n    gdprApplies: cmpConsentObject && typeof cmpConsentObject.gdprApplies === 'boolean' ? cmpConsentObject.gdprApplies : gdprScope\n  };\n  if (cmpConsentObject && cmpConsentObject.addtlConsent && isStr(cmpConsentObject.addtlConsent)) {\n    consentData.addtlConsent = cmpConsentObject.addtlConsent;\n  }\n  consentData.apiVersion = CMP_VERSION;\n  return consentData;\n}\n\n/**\n * Simply resets the module's consentData variable back to undefined, mainly for testing purposes\n */\nexport function resetConsentData() {\n  consentConfig = {};\n  gdprDataHandler.reset();\n}\n\nconst parseConfig = configParser({\n  namespace: 'gdpr',\n  displayName: 'TCF',\n  consentDataHandler: gdprDataHandler,\n  cmpHandlers: cmpCallMap,\n  parseConsentData,\n  getNullConsent: () => toConsentData(null)\n})\n/**\n * A configuration function that initializes some module variables, as well as add a hook into the requestBids function\n * @param {{cmp:string, timeout:number, defaultGdprScope:boolean}} config required; consentManagement module config settings; cmp (string), timeout (int))\n */\nexport function setConsentConfig(config) {\n  // if `config.gdpr`, `config.usp` or `config.gpp` exist, assume new config format.\n  // else for backward compatability, just use `config`\n  config = config && (config.gdpr || config.usp || config.gpp ? config.gdpr : config);\n  if (config?.consentData?.getTCData != null) {\n    config.consentData = config.consentData.getTCData;\n  }\n  gdprScope = config?.defaultGdprScope === true;\n  dsaPlatform = !!config?.dsaPlatform;\n  consentConfig = parseConfig({gdpr: config});\n  return consentConfig.loadConsentData?.()?.catch?.(() => null);\n}\nconfig.getConfig('consentManagement', config => setConsentConfig(config.consentManagement));\n\nexport function enrichFPDHook(next, fpd) {\n  return next(fpd.then(ortb2 => {\n    const consent = gdprDataHandler.getConsentData();\n    if (consent) {\n      if (typeof consent.gdprApplies === 'boolean') {\n        deepSetValue(ortb2, 'regs.ext.gdpr', consent.gdprApplies ? 1 : 0);\n      }\n      deepSetValue(ortb2, 'user.ext.consent', consent.consentString);\n    }\n    if (dsaPlatform) {\n      deepSetValue(ortb2, 'regs.ext.dsa.dsarequired', 3);\n    }\n    return ortb2;\n  }));\n}\n\nenrichFPD.before(enrichFPDHook);\n\nexport function setOrtbAdditionalConsent(ortbRequest, bidderRequest) {\n  // this is not a standardized name for addtlConsent, so keep this as an ORTB library processor rather than an FPD enrichment\n  const addtl = bidderRequest.gdprConsent?.addtlConsent;\n  if (addtl && typeof addtl === 'string') {\n    deepSetValue(ortbRequest, 'user.ext.ConsentedProvidersSettings.consented_providers', addtl);\n  }\n}\n\nregisterOrtbProcessor({type: REQUEST, name: 'gdprAddtlConsent', fn: setOrtbAdditionalConsent})\n"],"names":["registerModule","__r0","deepSetValue","isStr","logInfo","config","gdprDataHandler","registerOrtbProcessor","REQUEST","enrichFPD","cmpClient","configParser","consentConfig","gdprScope","dsaPlatform","CMP_VERSION","cmpCallMap","lookupIabConsent","setProvisionalConsent","Promise","resolve","reject","cmpResponseCallback","tcfData","success","parseConsentData","e","gdprApplies","eventStatus","setConsentData","Error","cmp","apiName","apiVersion","apiArgs","isDirect","command","callback","consentObject","checkData","tcString","Object","assign","args","toConsentData","cmpConsentObject","consentData","consentString","undefined","vendorData","addtlConsent","resetConsentData","reset","parseConfig","namespace","displayName","consentDataHandler","cmpHandlers","getNullConsent","setConsentConfig","gdpr","usp","gpp","getTCData","defaultGdprScope","loadConsentData","catch","getConfig","consentManagement","enrichFPDHook","next","fpd","then","ortb2","consent","getConsentData","before","setOrtbAdditionalConsent","ortbRequest","bidderRequest","addtl","gdprConsent","type","name","fn"],"sourceRoot":""}