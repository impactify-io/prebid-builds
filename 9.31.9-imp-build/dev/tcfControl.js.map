{"version":3,"file":"tcfControl.js","mappings":"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","sources":["webpack://prebid.js/./modules/tcfControl.js"],"sourcesContent":["/**\n * This module gives publishers extra set of features to enforce individual purposes of TCF v2\n */\n\nimport {deepAccess, logError, logWarn} from '../src/utils.js';\nimport {config} from '../src/config.js';\nimport adapterManager, {gdprDataHandler} from '../src/adapterManager.js';\nimport * as events from '../src/events.js';\nimport {EVENTS} from '../src/constants.js';\nimport {GDPR_GVLIDS, VENDORLESS_GVLID} from '../src/consentHandler.js';\nimport {\n  MODULE_TYPE_ANALYTICS,\n  MODULE_TYPE_BIDDER,\n  MODULE_TYPE_PREBID,\n  MODULE_TYPE_RTD,\n  MODULE_TYPE_UID\n} from '../src/activities/modules.js';\nimport {\n  ACTIVITY_PARAM_ANL_CONFIG,\n  ACTIVITY_PARAM_COMPONENT_NAME,\n  ACTIVITY_PARAM_COMPONENT_TYPE\n} from '../src/activities/params.js';\nimport {registerActivityControl} from '../src/activities/rules.js';\nimport {\n  ACTIVITY_ACCESS_DEVICE,\n  ACTIVITY_ENRICH_EIDS,\n  ACTIVITY_ENRICH_UFPD,\n  ACTIVITY_FETCH_BIDS,\n  ACTIVITY_REPORT_ANALYTICS,\n  ACTIVITY_SYNC_USER,\n  ACTIVITY_TRANSMIT_EIDS,\n  ACTIVITY_TRANSMIT_PRECISE_GEO,\n  ACTIVITY_TRANSMIT_UFPD\n} from '../src/activities/activities.js';\n\nexport const STRICT_STORAGE_ENFORCEMENT = 'strictStorageEnforcement';\n\nexport const ACTIVE_RULES = {\n  purpose: {},\n  feature: {}\n};\n\nconst CONSENT_PATHS = {\n  purpose: false,\n  feature: 'specialFeatureOptins'\n};\n\nconst CONFIGURABLE_RULES = {\n  storage: {\n    type: 'purpose',\n    default: {\n      purpose: 'storage',\n      enforcePurpose: true,\n      enforceVendor: true,\n      vendorExceptions: []\n    },\n    id: 1,\n  },\n  basicAds: {\n    type: 'purpose',\n    id: 2,\n    default: {\n      purpose: 'basicAds',\n      enforcePurpose: true,\n      enforceVendor: true,\n      vendorExceptions: []\n    }\n  },\n  personalizedAds: {\n    type: 'purpose',\n    id: 4,\n  },\n  measurement: {\n    type: 'purpose',\n    id: 7,\n  },\n  transmitPreciseGeo: {\n    type: 'feature',\n    id: 1,\n  },\n};\n\nconst storageBlocked = new Set();\nconst biddersBlocked = new Set();\nconst analyticsBlocked = new Set();\nconst ufpdBlocked = new Set();\nconst eidsBlocked = new Set();\nconst geoBlocked = new Set();\n\nlet hooksAdded = false;\nlet strictStorageEnforcement = false;\n\nconst GVLID_LOOKUP_PRIORITY = [\n  MODULE_TYPE_BIDDER,\n  MODULE_TYPE_UID,\n  MODULE_TYPE_ANALYTICS,\n  MODULE_TYPE_RTD\n];\n\nconst RULE_NAME = 'TCF2';\nconst RULE_HANDLES = [];\n\n// in JS we do not have access to the GVL; assume that everyone declares legitimate interest for basic ads\nconst LI_PURPOSES = [2];\nconst PUBLISHER_LI_PURPOSES = [2, 7, 9, 10];\n\n/**\n * Retrieve a module's GVL ID.\n */\nexport function getGvlid(moduleType, moduleName, fallbackFn) {\n  if (moduleName) {\n    // Check user defined GVL Mapping in pbjs.setConfig()\n    const gvlMapping = config.getConfig('gvlMapping');\n\n    // Return GVL ID from user defined gvlMapping\n    if (gvlMapping && gvlMapping[moduleName]) {\n      return gvlMapping[moduleName];\n    } else if (moduleType === MODULE_TYPE_PREBID) {\n      return VENDORLESS_GVLID;\n    } else {\n      let {gvlid, modules} = GDPR_GVLIDS.get(moduleName);\n      if (gvlid == null && Object.keys(modules).length > 0) {\n        // this behavior is for backwards compatibility; if multiple modules with the same\n        // name declare different GVL IDs, pick the bidder's first, then userId, then analytics\n        for (const type of GVLID_LOOKUP_PRIORITY) {\n          if (modules.hasOwnProperty(type)) {\n            gvlid = modules[type];\n            if (type !== moduleType) {\n              logWarn(`Multiple GVL IDs found for module '${moduleName}'; using the ${type} module's ID (${gvlid}) instead of the ${moduleType}'s ID (${modules[moduleType]})`);\n            }\n            break;\n          }\n        }\n      }\n      if (gvlid == null && fallbackFn) {\n        gvlid = fallbackFn();\n      }\n      return gvlid || null;\n    }\n  }\n  return null;\n}\n\n/**\n * Retrieve GVL IDs that are dynamically set on analytics adapters.\n */\nexport function getGvlidFromAnalyticsAdapter(code, config) {\n  const adapter = adapterManager.getAnalyticsAdapter(code);\n  return ((gvlid) => {\n    if (typeof gvlid !== 'function') return gvlid;\n    try {\n      return gvlid.call(adapter.adapter, config);\n    } catch (e) {\n      logError(`Error invoking ${code} adapter.gvlid()`, e);\n    }\n  })(adapter?.adapter?.gvlid);\n}\n\nexport function shouldEnforce(consentData, purpose, name) {\n  if (consentData == null && gdprDataHandler.enabled) {\n    // there is no consent data, but the GDPR module has been installed and configured\n    // NOTE: this check is not foolproof, as when Prebid first loads, enforcement hooks have not been attached yet\n    // This piece of code would not run at all, and `gdprDataHandler.enabled` would be false, until the first\n    // `setConfig({consentManagement})`\n    logWarn(`Attempting operation that requires purpose ${purpose} consent while consent data is not available${name ? ` (module: ${name})` : ''}. Assuming no consent was given.`);\n    return true;\n  }\n  return consentData && consentData.gdprApplies;\n}\n\nfunction getConsentOrLI(consentData, path, id, acceptLI) {\n  const data = deepAccess(consentData, `vendorData.${path}`);\n  return !!data?.consents?.[id] || (acceptLI && !!data?.legitimateInterests?.[id]);\n}\n\nfunction getConsent(consentData, type, purposeNo, gvlId) {\n  let purpose;\n  if (CONSENT_PATHS[type] !== false) {\n    purpose = !!deepAccess(consentData, `vendorData.${CONSENT_PATHS[type]}.${purposeNo}`);\n  } else {\n    const [path, liPurposes] = gvlId === VENDORLESS_GVLID\n      ? ['publisher', PUBLISHER_LI_PURPOSES]\n      : ['purpose', LI_PURPOSES];\n    purpose = getConsentOrLI(consentData, path, purposeNo, liPurposes.includes(purposeNo));\n  }\n  return {\n    purpose,\n    vendor: getConsentOrLI(consentData, 'vendor', gvlId, LI_PURPOSES.includes(purposeNo))\n  }\n}\n\n/**\n * This function takes in a rule and consentData and validates against the consentData provided. Depending on what it returns,\n * the caller may decide to suppress a TCF-sensitive activity.\n * @param {Object} rule - enforcement rules set in config\n * @param {Object} consentData - gdpr consent data\n * @param {string=} currentModule - Bidder code of the current module\n * @param {number=} gvlId - GVL ID for the module\n * @returns {boolean}\n */\nexport function validateRules(rule, consentData, currentModule, gvlId) {\n  const ruleOptions = CONFIGURABLE_RULES[rule.purpose];\n\n  // return 'true' if vendor present in 'vendorExceptions'\n  if ((rule.vendorExceptions || []).includes(currentModule)) {\n    return true;\n  }\n  const vendorConsentRequred = rule.enforceVendor && !((gvlId === VENDORLESS_GVLID || (rule.softVendorExceptions || []).includes(currentModule)));\n  const {purpose, vendor} = getConsent(consentData, ruleOptions.type, ruleOptions.id, gvlId);\n  return (!rule.enforcePurpose || purpose) && (!vendorConsentRequred || vendor);\n}\n\nfunction gdprRule(purposeNo, checkConsent, blocked = null, gvlidFallback = () => null) {\n  return function (params) {\n    const consentData = gdprDataHandler.getConsentData();\n    const modName = params[ACTIVITY_PARAM_COMPONENT_NAME];\n\n    if (shouldEnforce(consentData, purposeNo, modName)) {\n      const gvlid = getGvlid(params[ACTIVITY_PARAM_COMPONENT_TYPE], modName, gvlidFallback(params));\n      let allow = !!checkConsent(consentData, modName, gvlid);\n      if (!allow) {\n        blocked && blocked.add(modName);\n        return {allow};\n      }\n    }\n  };\n}\n\nfunction singlePurposeGdprRule(purposeNo, blocked = null, gvlidFallback = () => null) {\n  return gdprRule(purposeNo, (cd, modName, gvlid) => !!validateRules(ACTIVE_RULES.purpose[purposeNo], cd, modName, gvlid), blocked, gvlidFallback);\n}\n\nfunction exceptPrebidModules(ruleFn) {\n  return function (params) {\n    if (params[ACTIVITY_PARAM_COMPONENT_TYPE] === MODULE_TYPE_PREBID) {\n      // TODO: this special case is for the PBS adapter (componentType is 'prebid')\n      // we should check for generic purpose 2 consent & vendor consent based on the PBS vendor's GVL ID;\n      // that is, however, a breaking change and skipped for now\n      return;\n    }\n    return ruleFn(params);\n  };\n}\n\nexport const accessDeviceRule = ((rule) => {\n  return function (params) {\n    // for vendorless (core) storage, do not enforce rules unless strictStorageEnforcement is set\n    if (params[ACTIVITY_PARAM_COMPONENT_TYPE] === MODULE_TYPE_PREBID && !strictStorageEnforcement) return;\n    return rule(params);\n  };\n})(singlePurposeGdprRule(1, storageBlocked));\n\nexport const syncUserRule = singlePurposeGdprRule(1, storageBlocked);\nexport const enrichEidsRule = singlePurposeGdprRule(1, storageBlocked);\nexport const fetchBidsRule = exceptPrebidModules(singlePurposeGdprRule(2, biddersBlocked));\nexport const reportAnalyticsRule = singlePurposeGdprRule(7, analyticsBlocked, (params) => getGvlidFromAnalyticsAdapter(params[ACTIVITY_PARAM_COMPONENT_NAME], params[ACTIVITY_PARAM_ANL_CONFIG]));\nexport const ufpdRule = singlePurposeGdprRule(4, ufpdBlocked);\n\nexport const transmitEidsRule = exceptPrebidModules((() => {\n  // Transmit EID special case:\n  // by default, legal basis or vendor exceptions for any purpose between 2 and 10\n  // (but disregarding enforcePurpose and enforceVendor config) is enough to allow EIDs through\n  function check2to10Consent(consentData, modName, gvlId) {\n    for (let pno = 2; pno <= 10; pno++) {\n      if (ACTIVE_RULES.purpose[pno]?.vendorExceptions?.includes(modName)) {\n        return true;\n      }\n      const {purpose, vendor} = getConsent(consentData, 'purpose', pno, gvlId);\n      if (purpose && (vendor || ACTIVE_RULES.purpose[pno]?.softVendorExceptions?.includes(modName))) {\n        return true;\n      }\n    }\n    return false;\n  }\n\n  const defaultBehavior = gdprRule('2-10', check2to10Consent, eidsBlocked);\n  const p4Behavior = singlePurposeGdprRule(4, eidsBlocked);\n  return function () {\n    const fn = ACTIVE_RULES.purpose[4]?.eidsRequireP4Consent ? p4Behavior : defaultBehavior;\n    return fn.apply(this, arguments);\n  };\n})());\n\nexport const transmitPreciseGeoRule = gdprRule('Special Feature 1', (cd, modName, gvlId) => validateRules(ACTIVE_RULES.feature[1], cd, modName, gvlId), geoBlocked);\n\n/**\n * Compiles the TCF2.0 enforcement results into an object, which is emitted as an event payload to \"tcf2Enforcement\" event.\n */\nfunction emitTCF2FinalResults() {\n  // remove null and duplicate values\n  const formatSet = function (st) {\n    return Array.from(st.keys()).filter(el => el != null);\n  };\n  const tcf2FinalResults = {\n    storageBlocked: formatSet(storageBlocked),\n    biddersBlocked: formatSet(biddersBlocked),\n    analyticsBlocked: formatSet(analyticsBlocked),\n    ufpdBlocked: formatSet(ufpdBlocked),\n    eidsBlocked: formatSet(eidsBlocked),\n    geoBlocked: formatSet(geoBlocked)\n  };\n\n  events.emit(EVENTS.TCF2_ENFORCEMENT, tcf2FinalResults);\n  [storageBlocked, biddersBlocked, analyticsBlocked, ufpdBlocked, eidsBlocked, geoBlocked].forEach(el => el.clear());\n}\n\nevents.on(EVENTS.AUCTION_END, emitTCF2FinalResults);\n\n/**\n * A configuration function that initializes some module variables, as well as adds hooks\n * @param {Object} config - GDPR enforcement config object\n */\nexport function setEnforcementConfig(config) {\n  let rules = deepAccess(config, 'gdpr.rules');\n  if (!rules) {\n    logWarn('TCF2: enforcing P1 and P2 by default');\n  }\n  rules = Object.fromEntries((rules || []).map(r => [r.purpose, r]));\n  strictStorageEnforcement = !!deepAccess(config, STRICT_STORAGE_ENFORCEMENT);\n\n  Object.entries(CONFIGURABLE_RULES).forEach(([name, opts]) => {\n    ACTIVE_RULES[opts.type][opts.id] = rules[name] ?? opts.default;\n  });\n\n  if (!hooksAdded) {\n    if (ACTIVE_RULES.purpose[1] != null) {\n      hooksAdded = true;\n      RULE_HANDLES.push(registerActivityControl(ACTIVITY_ACCESS_DEVICE, RULE_NAME, accessDeviceRule));\n      RULE_HANDLES.push(registerActivityControl(ACTIVITY_SYNC_USER, RULE_NAME, syncUserRule));\n      RULE_HANDLES.push(registerActivityControl(ACTIVITY_ENRICH_EIDS, RULE_NAME, enrichEidsRule));\n    }\n    if (ACTIVE_RULES.purpose[2] != null) {\n      RULE_HANDLES.push(registerActivityControl(ACTIVITY_FETCH_BIDS, RULE_NAME, fetchBidsRule));\n    }\n    if (ACTIVE_RULES.purpose[4] != null) {\n      RULE_HANDLES.push(\n        registerActivityControl(ACTIVITY_TRANSMIT_UFPD, RULE_NAME, ufpdRule),\n        registerActivityControl(ACTIVITY_ENRICH_UFPD, RULE_NAME, ufpdRule)\n      );\n    }\n    if (ACTIVE_RULES.purpose[7] != null) {\n      RULE_HANDLES.push(registerActivityControl(ACTIVITY_REPORT_ANALYTICS, RULE_NAME, reportAnalyticsRule));\n    }\n    if (ACTIVE_RULES.feature[1] != null) {\n      RULE_HANDLES.push(registerActivityControl(ACTIVITY_TRANSMIT_PRECISE_GEO, RULE_NAME, transmitPreciseGeoRule));\n    }\n    RULE_HANDLES.push(registerActivityControl(ACTIVITY_TRANSMIT_EIDS, RULE_NAME, transmitEidsRule));\n  }\n}\n\nexport function uninstall() {\n  while (RULE_HANDLES.length) RULE_HANDLES.pop()();\n  hooksAdded = false;\n}\n\nconfig.getConfig('consentManagement', config => setEnforcementConfig(config.consentManagement));\n"],"names":["registerModule","__r0","deepAccess","logError","logWarn","config","adapterManager","gdprDataHandler","events","EVENTS","GDPR_GVLIDS","VENDORLESS_GVLID","MODULE_TYPE_ANALYTICS","MODULE_TYPE_BIDDER","MODULE_TYPE_PREBID","MODULE_TYPE_RTD","MODULE_TYPE_UID","ACTIVITY_PARAM_ANL_CONFIG","ACTIVITY_PARAM_COMPONENT_NAME","ACTIVITY_PARAM_COMPONENT_TYPE","registerActivityControl","ACTIVITY_ACCESS_DEVICE","ACTIVITY_ENRICH_EIDS","ACTIVITY_ENRICH_UFPD","ACTIVITY_FETCH_BIDS","ACTIVITY_REPORT_ANALYTICS","ACTIVITY_SYNC_USER","ACTIVITY_TRANSMIT_EIDS","ACTIVITY_TRANSMIT_PRECISE_GEO","ACTIVITY_TRANSMIT_UFPD","STRICT_STORAGE_ENFORCEMENT","ACTIVE_RULES","purpose","feature","CONSENT_PATHS","CONFIGURABLE_RULES","storage","type","default","enforcePurpose","enforceVendor","vendorExceptions","id","basicAds","personalizedAds","measurement","transmitPreciseGeo","storageBlocked","Set","biddersBlocked","analyticsBlocked","ufpdBlocked","eidsBlocked","geoBlocked","hooksAdded","strictStorageEnforcement","GVLID_LOOKUP_PRIORITY","RULE_NAME","RULE_HANDLES","LI_PURPOSES","PUBLISHER_LI_PURPOSES","getGvlid","moduleType","moduleName","fallbackFn","gvlMapping","getConfig","gvlid","modules","get","Object","keys","length","hasOwnProperty","getGvlidFromAnalyticsAdapter","code","adapter","getAnalyticsAdapter","call","e","shouldEnforce","consentData","name","enabled","gdprApplies","getConsentOrLI","path","acceptLI","data","consents","legitimateInterests","getConsent","purposeNo","gvlId","liPurposes","includes","vendor","validateRules","rule","currentModule","ruleOptions","vendorConsentRequred","softVendorExceptions","gdprRule","checkConsent","blocked","arguments","undefined","gvlidFallback","params","getConsentData","modName","allow","add","singlePurposeGdprRule","cd","exceptPrebidModules","ruleFn","accessDeviceRule","syncUserRule","enrichEidsRule","fetchBidsRule","reportAnalyticsRule","ufpdRule","transmitEidsRule","check2to10Consent","pno","defaultBehavior","p4Behavior","fn","eidsRequireP4Consent","apply","transmitPreciseGeoRule","emitTCF2FinalResults","formatSet","st","Array","from","filter","el","tcf2FinalResults","emit","TCF2_ENFORCEMENT","forEach","clear","on","AUCTION_END","setEnforcementConfig","rules","fromEntries","map","r","entries","_ref","opts","push","uninstall","pop","consentManagement"],"sourceRoot":""}